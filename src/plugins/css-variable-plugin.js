const plugin = require('tailwindcss/plugin')
const fs = require('fs')
const path = require('path')

const cssVariablePlugin = plugin.withOptions(
  (options = {}) => {
    return ({ addBase, theme }) => {
      // This plugin automatically generates theme extensions from CSS variables
    }
  },
  (options = {}) => {
    const {
      variables = {},
      debug = false,
      cssFile = './global.css',
      autoScan = false,
      patterns = {},
    } = options

    if (debug) {
      console.log(
        '[CSS Variable Plugin] Configuration received:',
        JSON.stringify(variables, null, 2)
      )
    }

    // Function to scan CSS file for CSS variables
    const scanCssVariables = (filePath) => {
      try {
        const cssContent = fs.readFileSync(path.resolve(filePath), 'utf8')
        const variableRegex = /--([a-zA-Z0-9-_]+):\s*([^;]+);/g
        const foundVariables = {}
        let match

        while ((match = variableRegex.exec(cssContent)) !== null) {
          const [, varName, varValue] = match
          foundVariables[varName] = varValue.trim()
        }

        if (debug) {
          console.log(
            `[CSS Variable Plugin] Found ${Object.keys(foundVariables).length} CSS variables in ${filePath}`
          )
          console.log(
            '[CSS Variable Plugin] Sample variables:',
            Object.keys(foundVariables).slice(0, 10)
          )
        }

        return foundVariables
      } catch (error) {
        if (debug) {
          console.log(
            `[CSS Variable Plugin] Could not read CSS file ${filePath}:`,
            error.message
          )
        }
        return {}
      }
    }

    // Auto-scan CSS file if enabled
    let scannedVariables = {}
    if (autoScan) {
      // Try multiple possible paths for the CSS file
      const possiblePaths = [
        cssFile,
        cssFile.replace('./', `${process.cwd()}/`),
        `${process.cwd()}/${cssFile.replace('./', '')}`,
        path.resolve(cssFile),
      ]

      for (const filePath of possiblePaths) {
        scannedVariables = scanCssVariables(filePath)
        if (Object.keys(scannedVariables).length > 0) {
          if (debug) {
            console.log(
              `[CSS Variable Plugin] Successfully read CSS file from: ${filePath}`
            )
          }
          break
        }
      }

      if (Object.keys(scannedVariables).length === 0 && debug) {
        console.log(
          '[CSS Variable Plugin] Could not find CSS file at any of these paths:',
          possiblePaths
        )
      }
    }

    // Process patterns to auto-generate variables from scanned CSS
    const processPatterns = (scannedVars, patterns) => {
      const autoVariables = {}

      Object.entries(patterns).forEach(([themeKey, pattern]) => {
        const regex = new RegExp(pattern)
        const matchedVars = Object.keys(scannedVars).filter((varName) =>
          regex.test(varName)
        )

        if (matchedVars.length > 0) {
          autoVariables[themeKey] = matchedVars
          if (debug) {
            console.log(
              `[CSS Variable Plugin] Pattern "${pattern}" matched ${matchedVars.length} variables for ${themeKey}`
            )
            console.log(
              `[CSS Variable Plugin] Matched variables:`,
              matchedVars.slice(0, 5)
            )
          }
        }
      })

      return autoVariables
    }

    // Merge manually specified variables with auto-scanned ones
    const autoGeneratedVariables = autoScan
      ? processPatterns(scannedVariables, patterns)
      : {}
    const allVariables = { ...autoGeneratedVariables, ...variables }

    if (debug && autoScan) {
      console.log(
        '[CSS Variable Plugin] Auto-generated variables:',
        JSON.stringify(autoGeneratedVariables, null, 2)
      )
      console.log(
        '[CSS Variable Plugin] Final merged variables:',
        JSON.stringify(allVariables, null, 2)
      )
    }

    // Generate theme extensions automatically
    const themeExtensions = {}

    Object.entries(allVariables).forEach(([themeKey, variableList]) => {
      if (debug) {
        console.log(`[CSS Variable Plugin] Processing theme key: ${themeKey}`)
        console.log(`[CSS Variable Plugin] Variable list:`, variableList)
      }

      themeExtensions[themeKey] = {}

      if (Array.isArray(variableList)) {
        if (debug)
          console.log(
            `[CSS Variable Plugin] Processing array format for ${themeKey}`
          )
        // Handle array of variable names
        variableList.forEach((variable) => {
          // Extract key name from CSS variable (remove -- prefix)
          const key = variable.replace(/^--/, '')
          const value = `var(--${key})`

          themeExtensions[themeKey][key] = value
          if (debug)
            console.log(`[CSS Variable Plugin] Generated: ${key} => ${value}`)
        })
      } else if (typeof variableList === 'object') {
        if (debug)
          console.log(
            `[CSS Variable Plugin] Processing object format for ${themeKey}`
          )
        // Handle object mapping
        Object.entries(variableList).forEach(([key, variable]) => {
          const value =
            typeof variable === 'string'
              ? variable.startsWith('--')
                ? `var(${variable})`
                : variable
              : variable

          themeExtensions[themeKey][key] = value
          if (debug)
            console.log(`[CSS Variable Plugin] Generated: ${key} => ${value}`)
        })
      }
    })

    if (debug) {
      console.log(
        '[CSS Variable Plugin] Final theme extensions:',
        JSON.stringify(themeExtensions, null, 2)
      )
    }

    return {
      theme: {
        extend: themeExtensions,
      },
    }
  }
)

module.exports = cssVariablePlugin
